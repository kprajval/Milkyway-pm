<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
        .modal-content { background:white; margin:10% auto; padding:20px; width:600px; border-radius:8px; }
        .btn-cancel { background: #ccc; border: none; padding: 10px; cursor: pointer; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>
    <nav>
        <a th:href="@{/}">Dashboard</a>
        <a th:href="@{/performance}">Performance</a>
        <a th:href="@{/market-lookup}">Market Lookup</a>
        <a th:href="@{/transaction-history}">Transaction History</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="first-part">
        <h3>Account Summary</h3>
        <p>Total Purse: $<span id="stat-purse">--</span></p>
        <p>Portfolio Value: $<span id="stat-portfolio">--</span></p>
        <p>Profit/Loss: <span id="stat-pl">--</span></p>
        <p>Total Change: <span id="stat-change">--</span>%</p>
    </div>

    <div class="second-part" style="display: flex; justify-content: center; padding: 20px;">
        <div style="width: 400px;">
            <h3 style="text-align: center;">Asset Allocation (Market Value)</h3>
            <canvas id="allocationChart"></canvas>
        </div>
    </div>

    <div class="third-part">
        <h3>Current Holdings</h3>
        <table id="holdingsTable">
            <thead>
                <tr>
                    <th>Stock</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Invested</th>
                    <th>Market Value</th>
                    <th>P/L</th>
                    <th>Change %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${holdings}" class="stock-row" th:data-stock="${item.stock}">
                    <td th:text="${item.stock}">Stock</td>
                    <td class="qty" th:text="${item.quantity}">0</td>
                    <td class="current-price">Loading...</td>
                    <td class="investment-value" th:text="${item.total_invested}">0.00</td> 
                    <td class="market-value">--</td>
                    <td class="profit-loss">--</td>
                    <td class="pct-change">--</td>
                    <td>
                        <button th:onclick="showGraph([[${item.stock}]])">ðŸ“Š Graph</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="graphModal" class="modal">
        <div class="modal-content">
            <h3 id="graphTitle">Stock History</h3>
            <canvas id="stockChart"></canvas>
            <button class="btn-cancel" onclick="closeGraph()">Close</button>
        </div>
    </div>

    <script>
        let myChart = null;
        let allocationChart = null;

        async function initDashboard() {
            const rows = document.querySelectorAll('.stock-row');
            let totalPortfolioValue = 0;
            let totalInvestment = 0;
            
            const labels = [];
            const marketValues = [];

            // 1. Fetch Purse Value (Spring Boot API)
            try {
                const purseResp = await fetch('/api/purse-value');
                const purseValue = await purseResp.json();
                document.getElementById('stat-purse').innerText = purseValue.toFixed(2);
            } catch (e) { console.error("Purse fetch error", e); }

            // 2. Process Holdings and Fetch Prices (Python Proxy)
            for (const row of rows) {
                const stockCode = row.getAttribute('data-stock');
                try {
                    const response = await fetch(`http://localhost:3000/quote/${stockCode}`);
                    const data = await response.json();
                    
                    if (data.price) {
                        const qty = parseFloat(row.querySelector('.qty').innerText) || 0;
                        const investVal = parseFloat(row.querySelector('.investment-value').innerText) || 0;
                        const marketValue = data.price * qty;
                        const profitLoss = marketValue - investVal;
                        const pctChange = investVal !== 0 ? ((profitLoss / investVal) * 100) : 0;

                        // Update Table
                        row.querySelector('.current-price').innerText = `$${data.price.toFixed(2)}`;
                        row.querySelector('.market-value').innerText = `$${marketValue.toFixed(2)}`;
                        row.querySelector('.profit-loss').innerText = `$${profitLoss.toFixed(2)}`;
                        row.querySelector('.pct-change').innerText = `${pctChange.toFixed(2)}%`;
                        row.querySelector('.profit-loss').style.color = profitLoss >= 0 ? 'green' : 'red';

                        // Aggregate Totals
                        totalPortfolioValue += marketValue;
                        totalInvestment += investVal;

                        // Prepare Chart Data
                        labels.push(stockCode);
                        marketValues.push(marketValue.toFixed(2));
                    }
                } catch (e) { console.error("Error fetching", stockCode); }
            }

            // 3. Update Summary Stats
            const totalPL = totalPortfolioValue - totalInvestment;
            const totalPct = totalInvestment !== 0 ? (totalPL / totalInvestment) * 100 : 0;
            
            document.getElementById('stat-portfolio').innerText = totalPortfolioValue.toFixed(2);
            document.getElementById('stat-pl').innerText = `$${totalPL.toFixed(2)}`;
            document.getElementById('stat-pl').style.color = totalPL >= 0 ? 'green' : 'red';
            document.getElementById('stat-change').innerText = totalPct.toFixed(2);

            // 4. Render Donut Chart
            renderDonutChart(labels, marketValues);
        }

        function renderDonutChart(labels, data) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#2ecc71', '#3498db', '#f1c40f', '#e74c3c', '#9b59b6', '#34495e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        async function showGraph(symbol) {
            document.getElementById('graphModal').style.display = 'block';
            document.getElementById('graphTitle').innerText = symbol + " - 30 Day History";
            const response = await fetch(`http://localhost:3000/history/${symbol}`);
            const data = await response.json();
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (myChart) { myChart.destroy(); }
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Price ($)',
                        data: data.prices,
                        borderColor: '#2ecc71',
                        fill: false
                    }]
                }
            });
        }

        function closeGraph() {
            document.getElementById('graphModal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>